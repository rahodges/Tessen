/* ********************************************************** *
 * AMNS NitroCast v1.0 DAABManager Data Tier                    *
 * Autogenerated by NitroCast Â© 2007 Roy A.E Hodges             *
 * All Rights Reserved                                        *
 * ---------------------------------------------------------- *
 * Source code may not be reproduced or redistributed without *
 * written expressed permission from the author.              *
 * Permission is granted to modify source code by licencee.   *
 * These permissions do not extend to third parties.          *
 * ********************************************************** */

using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Text;
using Microsoft.Practices.EnterpriseLibrary.Data;
using Microsoft.Practices.EnterpriseLibrary.Caching;
using Amns.GreyFox.People;
using Amns.GreyFox.Security;
using Amns.Rappahanock;

namespace Amns.Tessen
{
	#region Child Flags Enumeration

	public enum DojoClassFlags : int { Instructor,
				InstructorPrivateContact,
				InstructorEmergencyContact,
				InstructorPublicContact,
				InstructorParent,
				InstructorRoot,
				InstructorMemberType,
				InstructorMemberTypeTemplate,
				InstructorMembership1,
				InstructorMembership2,
				InstructorMembership3,
				InstructorMembership4,
				InstructorMembership5,
				InstructorInstructor1,
				InstructorInstructor2,
				InstructorInstructor3,
				InstructorPromotionFlags,
				InstructorRank,
				InstructorUserAccount,
				InstructorCustomer,
				ParentSeminar,
				ParentSeminarLocation,
				ParentSeminarOptions,
				ParentSeminarItem,
				ParentDefinition,
				ParentDefinitionAccessControlGroup,
				ParentDefinitionInstructor,
				ParentDefinitionLocation,
				Location,
				AccessControlGroup,
				AccessControlGroupAllowedMemberType1,
				AccessControlGroupAllowedMemberType2,
				AccessControlGroupAllowedMemberType3,
				AccessControlGroupAllowedMemberType4,
				AccessControlGroupAllowedMemberType5,
				AccessControlGroupDeniedMemberType1,
				AccessControlGroupDeniedMemberType2,
				AccessControlGroupDeniedMemberType3,
				AccessControlGroupDeniedMemberType4,
				AccessControlGroupDeniedMemberType5};

	#endregion

	/// <summary>
	/// Datamanager for DojoClass objects.
	/// </summary>
	public class DojoClassManager
	{
		#region Manager Fields

		// Static Fields
		static bool isInitialized;

		// Private Fields
		string tableName = "kitTessen_Classes";
		public static readonly string LocationTable = "kitTessen_Locations";


		public string TableName
		{
			get { return tableName; }
			set { tableName = value; }
		}

		// Hashtable to cache separate tables
		static bool cacheEnabled	= true;
		public static bool CacheEnabled
		{
			get { return cacheEnabled; }
			set { cacheEnabled = value; }
		}

		#endregion

		#region Inner Join Field Array

		public static readonly string[] InnerJoinFields = new string[] {
			"DojoClassID",
			"Name",
			"InstructorID",
			"ParentSeminarID",
			"ParentDefinitionID",
			"LocationID",
			"AccessControlGroupID",
			"OccupancyMax",
			"OccupancyTarget",
			"OccupancyCurrent",
			"OccupancyCheckDate",
			"SigninStart",
			"SigninEnd",
			"ClassStart",
			"ClassEnd"
		};

		#endregion

		#region Join Field Array

		public static readonly string[,] JoinFields = new string[,] {
			{ "DojoClassID", "LONG", "-1" },
			{ "Name", "TEXT(75)", "" },
			{ "InstructorID", "LONG", "null" },
			{ "ParentSeminarID", "LONG", "null" },
			{ "ParentDefinitionID", "LONG", "null" },
			{ "LocationID", "LONG", "null" },
			{ "AccessControlGroupID", "LONG", "null" },
			{ "OccupancyMax", "LONG", "" },
			{ "OccupancyTarget", "LONG", "" },
			{ "OccupancyCurrent", "LONG", "" },
			{ "OccupancyCheckDate", "DATETIME", "" },
			{ "SigninStart", "DATETIME", "" },
			{ "SigninEnd", "DATETIME", "" },
			{ "ClassStart", "DATETIME", "" },
			{ "ClassEnd", "DATETIME", "" }
		};

		#endregion

		#region Default NitroCast Constructors

		static DojoClassManager()
		{
		}

		public DojoClassManager()
		{
		}

		#endregion

		#region Default NitroCast Constructors

		// Initialize
		public void Initialize(string connectionString)
		{
			if(!DojoClassManager.isInitialized)
			{
				DojoClassManager.isInitialized = true;
			}
		}
		#endregion

		#region Default NitroCast Insert Method

		/// <summary>
		/// Inserts a DojoClass into the database. All children should have been
		/// saved to the database before insertion. New children will not be
		/// related to this object in the database.
		/// </summary>
		/// <param name="_DojoClass">The DojoClass to insert into the database.</param>
		internal static int _insert(DojoClass dojoClass)
		{
			int id;
			string query;
			Database database;
			DbCommand dbCommand;

			database = DatabaseFactory.CreateDatabase();

			query = "INSERT INTO kitTessen_Classes " +
				"(" +
				"Name," +
				"InstructorID," +
				"ParentSeminarID," +
				"ParentDefinitionID," +
				"LocationID," +
				"AccessControlGroupID," +
				"OccupancyMax," +
				"OccupancyTarget," +
				"OccupancyCurrent," +
				"OccupancyCheckDate," +
				"SigninStart," +
				"SigninEnd," +
				"ClassStart," +
				"ClassEnd) VALUES (" +
				"@Name," +
				"@InstructorID," +
				"@ParentSeminarID," +
				"@ParentDefinitionID," +
				"@LocationID," +
				"@AccessControlGroupID," +
				"@OccupancyMax," +
				"@OccupancyTarget," +
				"@OccupancyCurrent," +
				"@OccupancyCheckDate," +
				"@SigninStart," +
				"@SigninEnd," +
				"@ClassStart," +
				"@ClassEnd);";

			if (database.ConnectionStringWithoutCredentials.StartsWith("provider=microsoft.jet.oledb.4.0"))
			{
				// Microsoft Access
				// Connection must remain open for IDENTITY to return correct value,
				// therefore use the dbCommand object's Connection directly to control
				// connection state.
				dbCommand = database.GetSqlStringCommand(query);
				fillParameters(database, dbCommand, dojoClass);
				dbCommand.Connection = database.CreateConnection();
				dbCommand.Connection.Open();
				dbCommand.ExecuteNonQuery();
				dbCommand.CommandText = "SELECT @@IDENTITY AS LastID";
				id = (int)dbCommand.ExecuteScalar();
				dbCommand.Connection.Close();
			}
			else
			{
				//// Microsoft SQL Server
				dbCommand = database.GetSqlStringCommand(query + " SELECT @LastID = SCOPE_IDENTITY();");
				fillParameters(database, dbCommand, dojoClass);
				database.AddOutParameter(dbCommand, "@LastID", DbType.Int32, 10);
				database.ExecuteNonQuery(dbCommand);
				id = (int)dbCommand.Parameters["@LastID"].Value;
			}
			// Store dojoClass in cache.
			if(cacheEnabled) cacheStore(dojoClass);
			return id;
		}

		#endregion

		#region Default NitroCast Update Method

		internal static int _update(DojoClass dojoClass)
		{
			Database database;
			DbCommand dbCommand;

			database = DatabaseFactory.CreateDatabase();

			dbCommand = database.GetSqlStringCommand("UPDATE kitTessen_Classes SET Name=@Name," +
				"InstructorID=@InstructorID," +
				"ParentSeminarID=@ParentSeminarID," +
				"ParentDefinitionID=@ParentDefinitionID," +
				"LocationID=@LocationID," +
				"AccessControlGroupID=@AccessControlGroupID," +
				"OccupancyMax=@OccupancyMax," +
				"OccupancyTarget=@OccupancyTarget," +
				"OccupancyCurrent=@OccupancyCurrent," +
				"OccupancyCheckDate=@OccupancyCheckDate," +
				"SigninStart=@SigninStart," +
				"SigninEnd=@SigninEnd," +
				"ClassStart=@ClassStart," +
				"ClassEnd=@ClassEnd WHERE DojoClassID=@DojoClassID;");

			fillParameters(database, dbCommand, dojoClass);
			database.AddInParameter(dbCommand, "DojoClassID", DbType.Int32, dojoClass.iD);
			// Abandon remaining updates if no rows have been updated by returning false immediately.
			if (database.ExecuteNonQuery(dbCommand) == 0) return -1;

			// Store dojoClass in cache.
			if (cacheEnabled) cacheStore(dojoClass);

			return dojoClass.iD;
		}

		#endregion

		#region Default NitroCast Fill Parameters Method

		private static void fillParameters(Database database, DbCommand dbCommand, DojoClass dojoClass)
		{
			#region Default

			addParameter(database, dbCommand, "@Name", DbType.String, dojoClass.name);
			if(dojoClass.instructor == null)
			{
				addParameter(database, dbCommand, "@InstructorID", DbType.Int32, DBNull.Value);
			}
			else
			{
				addParameter(database, dbCommand, "@InstructorID", DbType.Int32, dojoClass.instructor.ID);
			}
			if(dojoClass.parentSeminar == null)
			{
				addParameter(database, dbCommand, "@ParentSeminarID", DbType.Int32, DBNull.Value);
			}
			else
			{
				addParameter(database, dbCommand, "@ParentSeminarID", DbType.Int32, dojoClass.parentSeminar.ID);
			}
			if(dojoClass.parentDefinition == null)
			{
				addParameter(database, dbCommand, "@ParentDefinitionID", DbType.Int32, DBNull.Value);
			}
			else
			{
				addParameter(database, dbCommand, "@ParentDefinitionID", DbType.Int32, dojoClass.parentDefinition.ID);
			}
			if(dojoClass.location == null)
			{
				addParameter(database, dbCommand, "@LocationID", DbType.Int32, DBNull.Value);
			}
			else
			{
				addParameter(database, dbCommand, "@LocationID", DbType.Int32, dojoClass.location.ID);
			}
			if(dojoClass.accessControlGroup == null)
			{
				addParameter(database, dbCommand, "@AccessControlGroupID", DbType.Int32, DBNull.Value);
			}
			else
			{
				addParameter(database, dbCommand, "@AccessControlGroupID", DbType.Int32, dojoClass.accessControlGroup.ID);
			}

			#endregion

			#region Occupancy

			addParameter(database, dbCommand, "@OccupancyMax", DbType.Int32, dojoClass.occupancyMax);
			addParameter(database, dbCommand, "@OccupancyTarget", DbType.Int32, dojoClass.occupancyTarget);
			addParameter(database, dbCommand, "@OccupancyCurrent", DbType.Int32, dojoClass.occupancyCurrent);
			addParameter(database, dbCommand, "@OccupancyCheckDate", DbType.Date, dojoClass.occupancyCheckDate);

			#endregion

			#region Schedule

			addParameter(database, dbCommand, "@SigninStart", DbType.Date, dojoClass.signinStart);
			addParameter(database, dbCommand, "@SigninEnd", DbType.Date, dojoClass.signinEnd);
			addParameter(database, dbCommand, "@ClassStart", DbType.Date, dojoClass.classStart);
			addParameter(database, dbCommand, "@ClassEnd", DbType.Date, dojoClass.classEnd);

			#endregion

		}

		#endregion

		#region Parameters

		private static void addParameter(Database database, DbCommand command,
			string name, DbType dbType)
		{
			database.AddInParameter(command, name, dbType);
		}

		private static void addParameter(Database database, DbCommand command,
			string name, DbType dbType, object value)
		{
			database.AddInParameter(command, name, dbType, value);
		}

		private static void addParameter(Database database, DbCommand command,
			string name, DbType dbType, object value, object nullValue)
		{
			if (value == null)
				database.AddInParameter(command, name, dbType, nullValue);
			else
				database.AddInParameter(command, name, dbType, value);
		}

		private static void addParameter(Database database, DbCommand command,
			string name, DbType dbType, object value, object nullValue, object nullSubValue)
		{
			if (value == null || value == nullSubValue)
				database.AddInParameter(command, name, dbType, nullValue);
			else
				database.AddInParameter(command, name, dbType, value);
		}

		#endregion

		#region Default NitroCast Fill Method

		internal static bool _fill(DojoClass dojoClass)
		{
			// Clone item from cache.
			if(cacheEnabled)
			{
				object cachedObject = cacheFind(dojoClass.iD);
				if(cachedObject != null)
				{
					((DojoClass)cachedObject).CopyTo(dojoClass, true);
					return dojoClass.isSynced;
				}
			}

			StringBuilder query;
			Database database;
			DbCommand dbCommand;

			query = new StringBuilder("SELECT ");
			query.Append(string.Join(",", InnerJoinFields));
			query.Append(" FROM kitTessen_Classes WHERE DojoClassID=");
			query.Append(dojoClass.iD);
			query.Append(";");

			database = DatabaseFactory.CreateDatabase();
			dbCommand = database.GetSqlStringCommand(query.ToString());
			IDataReader r = database.ExecuteReader(dbCommand);

			if(!r.Read())
			{
				throw(new Exception(string.Format("Cannot find DojoClassID '{0}'.", 
					dojoClass.iD)));
			}

			FillFromReader(dojoClass, r, 0, 1);

			// Microsoft DAAB still needs to have the reader closed.
			r.Close();

			// Store dojoClass in cache.
			if(cacheEnabled) cacheStore(dojoClass);

			return true;
		}

		#endregion

		#region Default NitroCast GetCollection Method

		public DojoClassCollection GetCollection(string whereClause, string sortClause)
		{
			return GetCollection(0, whereClause, sortClause, null);
		}

		public DojoClassCollection GetCollection(string whereClause, string sortClause, params DojoClassFlags[] optionFlags)
		{
			return GetCollection(0, whereClause, sortClause, optionFlags);
		}

		public DojoClassCollection GetCollection(int topCount, string whereClause, string sortClause, params DojoClassFlags[] optionFlags)
		{
			StringBuilder query;
			Database database;
			DbCommand dbCommand;
			IDataReader r;
			DojoClassCollection dojoClassCollection;

			int innerJoinOffset;

			query = new StringBuilder("SELECT ");

			if(topCount > 0)
			{
				query.Append("TOP ");
				query.Append(topCount);
				query.Append(" ");
			}

			foreach(string columnName in InnerJoinFields)
			{
				query.Append("DojoClass.");
				query.Append(columnName);
				query.Append(",");
			}

			innerJoinOffset = InnerJoinFields.GetUpperBound(0) + 1;
			int instructorOffset = -1;
			int instructorPrivateContactOffset = -1;
			int instructorEmergencyContactOffset = -1;
			int instructorPublicContactOffset = -1;
			int instructorParentOffset = -1;
			int instructorRootOffset = -1;
			int instructorMemberTypeOffset = -1;
			int instructorMemberTypeTemplateOffset = -1;
			int instructorMembership1Offset = -1;
			int instructorMembership2Offset = -1;
			int instructorMembership3Offset = -1;
			int instructorMembership4Offset = -1;
			int instructorMembership5Offset = -1;
			int instructorInstructor1Offset = -1;
			int instructorInstructor2Offset = -1;
			int instructorInstructor3Offset = -1;
			int instructorRankOffset = -1;
			int instructorUserAccountOffset = -1;
			int instructorCustomerOffset = -1;
			int parentSeminarOffset = -1;
			int parentSeminarLocationOffset = -1;
			int parentSeminarItemOffset = -1;
			int parentDefinitionOffset = -1;
			int parentDefinitionAccessControlGroupOffset = -1;
			int parentDefinitionInstructorOffset = -1;
			int parentDefinitionLocationOffset = -1;
			int locationOffset = -1;
			int accessControlGroupOffset = -1;
			int accessControlGroupAllowedMemberType1Offset = -1;
			int accessControlGroupAllowedMemberType2Offset = -1;
			int accessControlGroupAllowedMemberType3Offset = -1;
			int accessControlGroupAllowedMemberType4Offset = -1;
			int accessControlGroupAllowedMemberType5Offset = -1;
			int accessControlGroupDeniedMemberType1Offset = -1;
			int accessControlGroupDeniedMemberType2Offset = -1;
			int accessControlGroupDeniedMemberType3Offset = -1;
			int accessControlGroupDeniedMemberType4Offset = -1;
			int accessControlGroupDeniedMemberType5Offset = -1;

			//
			// Append Option Flag Fields
			//
			if(optionFlags != null)
				for(int x = 0; x < optionFlags.Length; x++)
				{
					switch(optionFlags[x])
					{
						case DojoClassFlags.Instructor:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorOffset = innerJoinOffset;
							innerJoinOffset = instructorOffset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorPrivateContact:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_PrivateContact.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorPrivateContactOffset = innerJoinOffset;
							innerJoinOffset = instructorPrivateContactOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorEmergencyContact:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_EmergencyContact.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorEmergencyContactOffset = innerJoinOffset;
							innerJoinOffset = instructorEmergencyContactOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorPublicContact:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_PublicContact.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorPublicContactOffset = innerJoinOffset;
							innerJoinOffset = instructorPublicContactOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorParent:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Parent.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorParentOffset = innerJoinOffset;
							innerJoinOffset = instructorParentOffset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorRoot:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Root.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorRootOffset = innerJoinOffset;
							innerJoinOffset = instructorRootOffset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMemberType:
							for(int i = 0; i <= DojoMemberTypeManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_MemberType.");
								query.Append(DojoMemberTypeManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMemberTypeOffset = innerJoinOffset;
							innerJoinOffset = instructorMemberTypeOffset + DojoMemberTypeManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMemberTypeTemplate:
							for(int i = 0; i <= DojoMemberTypeTemplateManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_MemberTypeTemplate.");
								query.Append(DojoMemberTypeTemplateManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMemberTypeTemplateOffset = innerJoinOffset;
							innerJoinOffset = instructorMemberTypeTemplateOffset + DojoMemberTypeTemplateManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMembership1:
							for(int i = 0; i <= DojoMembershipManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Membership1.");
								query.Append(DojoMembershipManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMembership1Offset = innerJoinOffset;
							innerJoinOffset = instructorMembership1Offset + DojoMembershipManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMembership2:
							for(int i = 0; i <= DojoMembershipManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Membership2.");
								query.Append(DojoMembershipManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMembership2Offset = innerJoinOffset;
							innerJoinOffset = instructorMembership2Offset + DojoMembershipManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMembership3:
							for(int i = 0; i <= DojoMembershipManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Membership3.");
								query.Append(DojoMembershipManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMembership3Offset = innerJoinOffset;
							innerJoinOffset = instructorMembership3Offset + DojoMembershipManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMembership4:
							for(int i = 0; i <= DojoMembershipManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Membership4.");
								query.Append(DojoMembershipManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMembership4Offset = innerJoinOffset;
							innerJoinOffset = instructorMembership4Offset + DojoMembershipManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorMembership5:
							for(int i = 0; i <= DojoMembershipManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Membership5.");
								query.Append(DojoMembershipManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorMembership5Offset = innerJoinOffset;
							innerJoinOffset = instructorMembership5Offset + DojoMembershipManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorInstructor1:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Instructor1.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorInstructor1Offset = innerJoinOffset;
							innerJoinOffset = instructorInstructor1Offset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorInstructor2:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Instructor2.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorInstructor2Offset = innerJoinOffset;
							innerJoinOffset = instructorInstructor2Offset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorInstructor3:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Instructor3.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorInstructor3Offset = innerJoinOffset;
							innerJoinOffset = instructorInstructor3Offset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorRank:
							for(int i = 0; i <= DojoRankManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Rank.");
								query.Append(DojoRankManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorRankOffset = innerJoinOffset;
							innerJoinOffset = instructorRankOffset + DojoRankManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorUserAccount:
							for(int i = 0; i <= GreyFoxUserManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_UserAccount.");
								query.Append(GreyFoxUserManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorUserAccountOffset = innerJoinOffset;
							innerJoinOffset = instructorUserAccountOffset + GreyFoxUserManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.InstructorCustomer:
							for(int i = 0; i <= RHCustomerManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Instructor_Customer.");
								query.Append(RHCustomerManager.InnerJoinFields[i]);
								query.Append(",");
							}
							instructorCustomerOffset = innerJoinOffset;
							innerJoinOffset = instructorCustomerOffset + RHCustomerManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentSeminar:
							for(int i = 0; i <= DojoSeminarManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentSeminar.");
								query.Append(DojoSeminarManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentSeminarOffset = innerJoinOffset;
							innerJoinOffset = parentSeminarOffset + DojoSeminarManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentSeminarLocation:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentSeminar_Location.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentSeminarLocationOffset = innerJoinOffset;
							innerJoinOffset = parentSeminarLocationOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentSeminarItem:
							for(int i = 0; i <= RHItemManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentSeminar_Item.");
								query.Append(RHItemManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentSeminarItemOffset = innerJoinOffset;
							innerJoinOffset = parentSeminarItemOffset + RHItemManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentDefinition:
							for(int i = 0; i <= DojoClassDefinitionManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentDefinition.");
								query.Append(DojoClassDefinitionManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentDefinitionOffset = innerJoinOffset;
							innerJoinOffset = parentDefinitionOffset + DojoClassDefinitionManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentDefinitionAccessControlGroup:
							for(int i = 0; i <= DojoAccessControlGroupManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentDefinition_AccessControlGroup.");
								query.Append(DojoAccessControlGroupManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentDefinitionAccessControlGroupOffset = innerJoinOffset;
							innerJoinOffset = parentDefinitionAccessControlGroupOffset + DojoAccessControlGroupManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentDefinitionInstructor:
							for(int i = 0; i <= DojoMemberManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentDefinition_Instructor.");
								query.Append(DojoMemberManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentDefinitionInstructorOffset = innerJoinOffset;
							innerJoinOffset = parentDefinitionInstructorOffset + DojoMemberManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.ParentDefinitionLocation:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("ParentDefinition_Location.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							parentDefinitionLocationOffset = innerJoinOffset;
							innerJoinOffset = parentDefinitionLocationOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.Location:
							for(int i = 0; i <= GreyFoxContactManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("Location.");
								query.Append(GreyFoxContactManager.InnerJoinFields[i]);
								query.Append(",");
							}
							locationOffset = innerJoinOffset;
							innerJoinOffset = locationOffset + GreyFoxContactManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroup:
							for(int i = 0; i <= DojoAccessControlGroupManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup.");
								query.Append(DojoAccessControlGroupManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupOffset = innerJoinOffset;
							innerJoinOffset = accessControlGroupOffset + DojoAccessControlGroupManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType1:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_AllowedMemberType1.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupAllowedMemberType1Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupAllowedMemberType1Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType2:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_AllowedMemberType2.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupAllowedMemberType2Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupAllowedMemberType2Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType3:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_AllowedMemberType3.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupAllowedMemberType3Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupAllowedMemberType3Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType4:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_AllowedMemberType4.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupAllowedMemberType4Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupAllowedMemberType4Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType5:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_AllowedMemberType5.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupAllowedMemberType5Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupAllowedMemberType5Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType1:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_DeniedMemberType1.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupDeniedMemberType1Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupDeniedMemberType1Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType2:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_DeniedMemberType2.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupDeniedMemberType2Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupDeniedMemberType2Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType3:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_DeniedMemberType3.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupDeniedMemberType3Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupDeniedMemberType3Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType4:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_DeniedMemberType4.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupDeniedMemberType4Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupDeniedMemberType4Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType5:
							for(int i = 0; i <= DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0); i++)
							{
								query.Append("AccessControlGroup_DeniedMemberType5.");
								query.Append(DojoAttendanceEntryManager.InnerJoinFields[i]);
								query.Append(",");
							}
							accessControlGroupDeniedMemberType5Offset = innerJoinOffset;
							innerJoinOffset = accessControlGroupDeniedMemberType5Offset + DojoAttendanceEntryManager.InnerJoinFields.GetUpperBound(0) + 1;
							break;
					}
				}

			//
			// Remove trailing comma
			//
			query.Length--;
			if(optionFlags != null)
			{
				query.Append(" FROM ");

				//
				// Start INNER JOIN expressions
				//
				for(int x = 0; x < optionFlags.Length; x++)
					query.Append("(");

				query.Append("kitTessen_Classes AS DojoClass");
			}
			else
			{
				query.Append(" FROM kitTessen_Classes AS DojoClass");
			}
			//
			// Finish INNER JOIN expressions
			//
			if(optionFlags != null)
				for(int x = 0; x < optionFlags.Length; x++)
				{
					switch(optionFlags[x])
					{
						case DojoClassFlags.Instructor:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor ON DojoClass.InstructorID = Instructor.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorPrivateContact:
							query.Append(" LEFT JOIN kitTessen_Members_PrivateContacts AS Instructor_PrivateContact ON Instructor.PrivateContactID = Instructor_PrivateContact.GreyFoxContactID)");
							break;
						case DojoClassFlags.InstructorEmergencyContact:
							query.Append(" LEFT JOIN kitTessen_Members_EmergencyContacts AS Instructor_EmergencyContact ON Instructor.EmergencyContactID = Instructor_EmergencyContact.GreyFoxContactID)");
							break;
						case DojoClassFlags.InstructorPublicContact:
							query.Append(" LEFT JOIN kitTessen_Members_PublicContacts AS Instructor_PublicContact ON Instructor.PublicContactID = Instructor_PublicContact.GreyFoxContactID)");
							break;
						case DojoClassFlags.InstructorParent:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor_Parent ON Instructor.ParentID = Instructor_Parent.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorRoot:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor_Root ON Instructor.RootID = Instructor_Root.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorMemberType:
							query.Append(" LEFT JOIN kitTessen_MemberTypes AS Instructor_MemberType ON Instructor.MemberTypeID = Instructor_MemberType.DojoMemberTypeID)");
							break;
						case DojoClassFlags.InstructorMemberTypeTemplate:
							query.Append(" LEFT JOIN kitTessen_MemberTypeTemplates AS Instructor_MemberTypeTemplate ON Instructor.MemberTypeTemplateID = Instructor_MemberTypeTemplate.DojoMemberTypeTemplateID)");
							break;
						case DojoClassFlags.InstructorMembership1:
							query.Append(" LEFT JOIN kitTessen_Memberships AS Instructor_Membership1 ON Instructor.Membership1ID = Instructor_Membership1.DojoMembershipID)");
							break;
						case DojoClassFlags.InstructorMembership2:
							query.Append(" LEFT JOIN kitTessen_Memberships AS Instructor_Membership2 ON Instructor.Membership2ID = Instructor_Membership2.DojoMembershipID)");
							break;
						case DojoClassFlags.InstructorMembership3:
							query.Append(" LEFT JOIN kitTessen_Memberships AS Instructor_Membership3 ON Instructor.Membership3ID = Instructor_Membership3.DojoMembershipID)");
							break;
						case DojoClassFlags.InstructorMembership4:
							query.Append(" LEFT JOIN kitTessen_Memberships AS Instructor_Membership4 ON Instructor.Membership4ID = Instructor_Membership4.DojoMembershipID)");
							break;
						case DojoClassFlags.InstructorMembership5:
							query.Append(" LEFT JOIN kitTessen_Memberships AS Instructor_Membership5 ON Instructor.Membership5ID = Instructor_Membership5.DojoMembershipID)");
							break;
						case DojoClassFlags.InstructorInstructor1:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor_Instructor1 ON Instructor.Instructor1ID = Instructor_Instructor1.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorInstructor2:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor_Instructor2 ON Instructor.Instructor2ID = Instructor_Instructor2.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorInstructor3:
							query.Append(" LEFT JOIN kitTessen_Members AS Instructor_Instructor3 ON Instructor.Instructor3ID = Instructor_Instructor3.DojoMemberID)");
							break;
						case DojoClassFlags.InstructorRank:
							query.Append(" LEFT JOIN kitTessen_Ranks AS Instructor_Rank ON Instructor.RankID = Instructor_Rank.DojoRankID)");
							break;
						case DojoClassFlags.InstructorUserAccount:
							query.Append(" LEFT JOIN sysGlobal_Users AS Instructor_UserAccount ON Instructor.UserAccountID = Instructor_UserAccount.GreyFoxUserID)");
							break;
						case DojoClassFlags.InstructorCustomer:
							query.Append(" LEFT JOIN RH_Customers AS Instructor_Customer ON Instructor.CustomerID = Instructor_Customer.RHCustomerID)");
							break;
						case DojoClassFlags.ParentSeminar:
							query.Append(" LEFT JOIN kitTessen_Seminars AS ParentSeminar ON DojoClass.ParentSeminarID = ParentSeminar.DojoSeminarID)");
							break;
						case DojoClassFlags.ParentSeminarLocation:
							query.Append(" LEFT JOIN kitTessen_Locations AS ParentSeminar_Location ON ParentSeminar.LocationID = ParentSeminar_Location.GreyFoxContactID)");
							break;
						case DojoClassFlags.ParentSeminarItem:
							query.Append(" LEFT JOIN RH_Items AS ParentSeminar_Item ON ParentSeminar.ItemID = ParentSeminar_Item.RHItemID)");
							break;
						case DojoClassFlags.ParentDefinition:
							query.Append(" LEFT JOIN kitTessen_ClassDefinitions AS ParentDefinition ON DojoClass.ParentDefinitionID = ParentDefinition.DojoClassDefinitionID)");
							break;
						case DojoClassFlags.ParentDefinitionAccessControlGroup:
							query.Append(" LEFT JOIN kitTessen_AccessControlGroups AS ParentDefinition_AccessControlGroup ON ParentDefinition.AccessControlGroupID = ParentDefinition_AccessControlGroup.DojoAccessControlGroupID)");
							break;
						case DojoClassFlags.ParentDefinitionInstructor:
							query.Append(" LEFT JOIN kitTessen_Members AS ParentDefinition_Instructor ON ParentDefinition.InstructorID = ParentDefinition_Instructor.DojoMemberID)");
							break;
						case DojoClassFlags.ParentDefinitionLocation:
							query.Append(" LEFT JOIN kitTessen_Locations AS ParentDefinition_Location ON ParentDefinition.LocationID = ParentDefinition_Location.GreyFoxContactID)");
							break;
						case DojoClassFlags.Location:
							query.Append(" LEFT JOIN kitTessen_Locations AS Location ON DojoClass.LocationID = Location.GreyFoxContactID)");
							break;
						case DojoClassFlags.AccessControlGroup:
							query.Append(" LEFT JOIN kitTessen_AccessControlGroups AS AccessControlGroup ON DojoClass.AccessControlGroupID = AccessControlGroup.DojoAccessControlGroupID)");
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType1:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_AllowedMemberType1 ON AccessControlGroup.AllowedMemberType1ID = AccessControlGroup_AllowedMemberType1.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType2:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_AllowedMemberType2 ON AccessControlGroup.AllowedMemberType2ID = AccessControlGroup_AllowedMemberType2.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType3:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_AllowedMemberType3 ON AccessControlGroup.AllowedMemberType3ID = AccessControlGroup_AllowedMemberType3.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType4:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_AllowedMemberType4 ON AccessControlGroup.AllowedMemberType4ID = AccessControlGroup_AllowedMemberType4.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupAllowedMemberType5:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_AllowedMemberType5 ON AccessControlGroup.AllowedMemberType5ID = AccessControlGroup_AllowedMemberType5.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType1:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_DeniedMemberType1 ON AccessControlGroup.DeniedMemberType1ID = AccessControlGroup_DeniedMemberType1.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType2:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_DeniedMemberType2 ON AccessControlGroup.DeniedMemberType2ID = AccessControlGroup_DeniedMemberType2.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType3:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_DeniedMemberType3 ON AccessControlGroup.DeniedMemberType3ID = AccessControlGroup_DeniedMemberType3.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType4:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_DeniedMemberType4 ON AccessControlGroup.DeniedMemberType4ID = AccessControlGroup_DeniedMemberType4.DojoAttendanceEntryID)");
							break;
						case DojoClassFlags.AccessControlGroupDeniedMemberType5:
							query.Append(" LEFT JOIN kitTessen_Attendance AS AccessControlGroup_DeniedMemberType5 ON AccessControlGroup.DeniedMemberType5ID = AccessControlGroup_DeniedMemberType5.DojoAttendanceEntryID)");
							break;
					}
				}

			//
			// Render where clause
			//
			if(whereClause != string.Empty)
			{
				query.Append(" WHERE ");
				query.Append(whereClause);
			}

			//
			// Render sort clause 
			//
			if(sortClause != string.Empty)
			{
				query.Append(" ORDER BY ");
				query.Append(sortClause);
			}

			//
			// Render final semicolon
			//
			query.Append(";");
			database = DatabaseFactory.CreateDatabase();
			dbCommand = database.GetSqlStringCommand(query.ToString());
			#if DEBUG

			try
			{
				r = database.ExecuteReader(dbCommand);
			}
			catch (Exception e)
			{
				string msg = e.Message;
				throw(new Exception(msg + " --- Query: " + query.ToString()));

			}
			#else

			r = database.ExecuteReader(dbCommand);

			#endif

			dojoClassCollection = new DojoClassCollection();

			while(r.Read())
			{
				DojoClass dojoClass = ParseFromReader(r, 0, 1);

				// Fill Instructor
				if(instructorOffset != -1 && !r.IsDBNull(instructorOffset))
				{
					DojoMemberManager.FillFromReader(dojoClass.instructor, r, instructorOffset, instructorOffset+1);

					// Fill 
					if(instructorPrivateContactOffset != -1 && !r.IsDBNull(instructorPrivateContactOffset))
						GreyFoxContactManager.FillFromReader(dojoClass.instructor.PrivateContact, "kitTessen_Members_PrivateContacts", r, instructorPrivateContactOffset, instructorPrivateContactOffset+1);

					// Fill 
					if(instructorEmergencyContactOffset != -1 && !r.IsDBNull(instructorEmergencyContactOffset))
						GreyFoxContactManager.FillFromReader(dojoClass.instructor.EmergencyContact, "kitTessen_Members_EmergencyContacts", r, instructorEmergencyContactOffset, instructorEmergencyContactOffset+1);

					// Fill 
					if(instructorPublicContactOffset != -1 && !r.IsDBNull(instructorPublicContactOffset))
						GreyFoxContactManager.FillFromReader(dojoClass.instructor.PublicContact, "kitTessen_Members_PublicContacts", r, instructorPublicContactOffset, instructorPublicContactOffset+1);

					// Fill 
					if(instructorParentOffset != -1 && !r.IsDBNull(instructorParentOffset))
						DojoMemberManager.FillFromReader(dojoClass.instructor.Parent, r, instructorParentOffset, instructorParentOffset+1);

					// Fill 
					if(instructorRootOffset != -1 && !r.IsDBNull(instructorRootOffset))
						DojoMemberManager.FillFromReader(dojoClass.instructor.Root, r, instructorRootOffset, instructorRootOffset+1);

					// Fill 
					if(instructorMemberTypeOffset != -1 && !r.IsDBNull(instructorMemberTypeOffset))
						DojoMemberTypeManager.FillFromReader(dojoClass.instructor.MemberType, r, instructorMemberTypeOffset, instructorMemberTypeOffset+1);

					// Fill 
					if(instructorMemberTypeTemplateOffset != -1 && !r.IsDBNull(instructorMemberTypeTemplateOffset))
						DojoMemberTypeTemplateManager.FillFromReader(dojoClass.instructor.MemberTypeTemplate, r, instructorMemberTypeTemplateOffset, instructorMemberTypeTemplateOffset+1);

					// Fill 
					if(instructorMembership1Offset != -1 && !r.IsDBNull(instructorMembership1Offset))
						DojoMembershipManager.FillFromReader(dojoClass.instructor.Membership1, r, instructorMembership1Offset, instructorMembership1Offset+1);

					// Fill 
					if(instructorMembership2Offset != -1 && !r.IsDBNull(instructorMembership2Offset))
						DojoMembershipManager.FillFromReader(dojoClass.instructor.Membership2, r, instructorMembership2Offset, instructorMembership2Offset+1);

					// Fill 
					if(instructorMembership3Offset != -1 && !r.IsDBNull(instructorMembership3Offset))
						DojoMembershipManager.FillFromReader(dojoClass.instructor.Membership3, r, instructorMembership3Offset, instructorMembership3Offset+1);

					// Fill 
					if(instructorMembership4Offset != -1 && !r.IsDBNull(instructorMembership4Offset))
						DojoMembershipManager.FillFromReader(dojoClass.instructor.Membership4, r, instructorMembership4Offset, instructorMembership4Offset+1);

					// Fill 
					if(instructorMembership5Offset != -1 && !r.IsDBNull(instructorMembership5Offset))
						DojoMembershipManager.FillFromReader(dojoClass.instructor.Membership5, r, instructorMembership5Offset, instructorMembership5Offset+1);

					// Fill 
					if(instructorInstructor1Offset != -1 && !r.IsDBNull(instructorInstructor1Offset))
						DojoMemberManager.FillFromReader(dojoClass.instructor.Instructor1, r, instructorInstructor1Offset, instructorInstructor1Offset+1);

					// Fill 
					if(instructorInstructor2Offset != -1 && !r.IsDBNull(instructorInstructor2Offset))
						DojoMemberManager.FillFromReader(dojoClass.instructor.Instructor2, r, instructorInstructor2Offset, instructorInstructor2Offset+1);

					// Fill 
					if(instructorInstructor3Offset != -1 && !r.IsDBNull(instructorInstructor3Offset))
						DojoMemberManager.FillFromReader(dojoClass.instructor.Instructor3, r, instructorInstructor3Offset, instructorInstructor3Offset+1);

					// Fill 
					if(instructorRankOffset != -1 && !r.IsDBNull(instructorRankOffset))
						DojoRankManager.FillFromReader(dojoClass.instructor.Rank, r, instructorRankOffset, instructorRankOffset+1);

					// Fill 
					if(instructorUserAccountOffset != -1 && !r.IsDBNull(instructorUserAccountOffset))
						GreyFoxUserManager.FillFromReader(dojoClass.instructor.UserAccount, r, instructorUserAccountOffset, instructorUserAccountOffset+1);

					// Fill 
					if(instructorCustomerOffset != -1 && !r.IsDBNull(instructorCustomerOffset))
						RHCustomerManager.FillFromReader(dojoClass.instructor.Customer, r, instructorCustomerOffset, instructorCustomerOffset+1);

				}

				// Fill ParentSeminar
				if(parentSeminarOffset != -1 && !r.IsDBNull(parentSeminarOffset))
				{
					DojoSeminarManager.FillFromReader(dojoClass.parentSeminar, r, parentSeminarOffset, parentSeminarOffset+1);

					// Fill 
					if(parentSeminarLocationOffset != -1 && !r.IsDBNull(parentSeminarLocationOffset))
						GreyFoxContactManager.FillFromReader(dojoClass.parentSeminar.Location, "kitTessen_Locations", r, parentSeminarLocationOffset, parentSeminarLocationOffset+1);

					// Fill 
					if(parentSeminarItemOffset != -1 && !r.IsDBNull(parentSeminarItemOffset))
						RHItemManager.FillFromReader(dojoClass.parentSeminar.Item, r, parentSeminarItemOffset, parentSeminarItemOffset+1);

				}

				// Fill ParentDefinition
				if(parentDefinitionOffset != -1 && !r.IsDBNull(parentDefinitionOffset))
				{
					DojoClassDefinitionManager.FillFromReader(dojoClass.parentDefinition, r, parentDefinitionOffset, parentDefinitionOffset+1);

					// Fill 
					if(parentDefinitionAccessControlGroupOffset != -1 && !r.IsDBNull(parentDefinitionAccessControlGroupOffset))
						DojoAccessControlGroupManager.FillFromReader(dojoClass.parentDefinition.AccessControlGroup, r, parentDefinitionAccessControlGroupOffset, parentDefinitionAccessControlGroupOffset+1);

					// Fill 
					if(parentDefinitionInstructorOffset != -1 && !r.IsDBNull(parentDefinitionInstructorOffset))
						DojoMemberManager.FillFromReader(dojoClass.parentDefinition.Instructor, r, parentDefinitionInstructorOffset, parentDefinitionInstructorOffset+1);

					// Fill 
					if(parentDefinitionLocationOffset != -1 && !r.IsDBNull(parentDefinitionLocationOffset))
						GreyFoxContactManager.FillFromReader(dojoClass.parentDefinition.Location, "kitTessen_Locations", r, parentDefinitionLocationOffset, parentDefinitionLocationOffset+1);

				}

				// Fill Location
				if(locationOffset != -1 && !r.IsDBNull(locationOffset))
					GreyFoxContactManager.FillFromReader(dojoClass.location, "kitTessen_Locations", r, locationOffset, locationOffset+1);

				// Fill AccessControlGroup
				if(accessControlGroupOffset != -1 && !r.IsDBNull(accessControlGroupOffset))
				{
					DojoAccessControlGroupManager.FillFromReader(dojoClass.accessControlGroup, r, accessControlGroupOffset, accessControlGroupOffset+1);

					// Fill 
					if(accessControlGroupAllowedMemberType1Offset != -1 && !r.IsDBNull(accessControlGroupAllowedMemberType1Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.AllowedMemberType1, r, accessControlGroupAllowedMemberType1Offset, accessControlGroupAllowedMemberType1Offset+1);

					// Fill 
					if(accessControlGroupAllowedMemberType2Offset != -1 && !r.IsDBNull(accessControlGroupAllowedMemberType2Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.AllowedMemberType2, r, accessControlGroupAllowedMemberType2Offset, accessControlGroupAllowedMemberType2Offset+1);

					// Fill 
					if(accessControlGroupAllowedMemberType3Offset != -1 && !r.IsDBNull(accessControlGroupAllowedMemberType3Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.AllowedMemberType3, r, accessControlGroupAllowedMemberType3Offset, accessControlGroupAllowedMemberType3Offset+1);

					// Fill 
					if(accessControlGroupAllowedMemberType4Offset != -1 && !r.IsDBNull(accessControlGroupAllowedMemberType4Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.AllowedMemberType4, r, accessControlGroupAllowedMemberType4Offset, accessControlGroupAllowedMemberType4Offset+1);

					// Fill 
					if(accessControlGroupAllowedMemberType5Offset != -1 && !r.IsDBNull(accessControlGroupAllowedMemberType5Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.AllowedMemberType5, r, accessControlGroupAllowedMemberType5Offset, accessControlGroupAllowedMemberType5Offset+1);

					// Fill 
					if(accessControlGroupDeniedMemberType1Offset != -1 && !r.IsDBNull(accessControlGroupDeniedMemberType1Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.DeniedMemberType1, r, accessControlGroupDeniedMemberType1Offset, accessControlGroupDeniedMemberType1Offset+1);

					// Fill 
					if(accessControlGroupDeniedMemberType2Offset != -1 && !r.IsDBNull(accessControlGroupDeniedMemberType2Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.DeniedMemberType2, r, accessControlGroupDeniedMemberType2Offset, accessControlGroupDeniedMemberType2Offset+1);

					// Fill 
					if(accessControlGroupDeniedMemberType3Offset != -1 && !r.IsDBNull(accessControlGroupDeniedMemberType3Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.DeniedMemberType3, r, accessControlGroupDeniedMemberType3Offset, accessControlGroupDeniedMemberType3Offset+1);

					// Fill 
					if(accessControlGroupDeniedMemberType4Offset != -1 && !r.IsDBNull(accessControlGroupDeniedMemberType4Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.DeniedMemberType4, r, accessControlGroupDeniedMemberType4Offset, accessControlGroupDeniedMemberType4Offset+1);

					// Fill 
					if(accessControlGroupDeniedMemberType5Offset != -1 && !r.IsDBNull(accessControlGroupDeniedMemberType5Offset))
						DojoAttendanceEntryManager.FillFromReader(dojoClass.accessControlGroup.DeniedMemberType5, r, accessControlGroupDeniedMemberType5Offset, accessControlGroupDeniedMemberType5Offset+1);

				}

				dojoClassCollection.Add(dojoClass);
			}

			// Microsoft DAAB still needs to close readers.
			r.Close();

			return dojoClassCollection;
		}

		#endregion

		#region Default NitroCast ParseFromReader Method

		public static DojoClass ParseFromReader(IDataReader r, int idOffset, int dataOffset)
		{
			DojoClass dojoClass = new DojoClass();
			FillFromReader(dojoClass, r, idOffset, dataOffset);
			return dojoClass;
		}

		#endregion

		#region Default NitroCast FillFromReader Method

		/// <summary>
		/// Fills the {0} from a OleIDataReader.
		/// </summary>
		public static void FillFromReader(DojoClass dojoClass, IDataReader r, int idOffset, int dataOffset)
		{
			dojoClass.iD = r.GetInt32(idOffset);
			dojoClass.isSynced = true;
			dojoClass.isPlaceHolder = false;

			dojoClass.name = r.GetString(0+dataOffset);
			if(!r.IsDBNull(1+dataOffset) && r.GetInt32(1+dataOffset) > 0)
			{
				dojoClass.instructor = DojoMember.NewPlaceHolder(r.GetInt32(1+dataOffset));
			}
			if(!r.IsDBNull(2+dataOffset) && r.GetInt32(2+dataOffset) > 0)
			{
				dojoClass.parentSeminar = DojoSeminar.NewPlaceHolder(r.GetInt32(2+dataOffset));
			}
			if(!r.IsDBNull(3+dataOffset) && r.GetInt32(3+dataOffset) > 0)
			{
				dojoClass.parentDefinition = DojoClassDefinition.NewPlaceHolder(r.GetInt32(3+dataOffset));
			}
			if(!r.IsDBNull(4+dataOffset) && r.GetInt32(4+dataOffset) > 0)
			{
				dojoClass.location = GreyFoxContact.NewPlaceHolder("kitTessen_Locations", r.GetInt32(4+dataOffset));
			}
			if(!r.IsDBNull(5+dataOffset) && r.GetInt32(5+dataOffset) > 0)
			{
				dojoClass.accessControlGroup = DojoAccessControlGroup.NewPlaceHolder(r.GetInt32(5+dataOffset));
			}
			if(!r.IsDBNull(6+dataOffset)) 
				dojoClass.occupancyMax = r.GetInt32(6+dataOffset);
			if(!r.IsDBNull(7+dataOffset)) 
				dojoClass.occupancyTarget = r.GetInt32(7+dataOffset);
			if(!r.IsDBNull(8+dataOffset)) 
				dojoClass.occupancyCurrent = r.GetInt32(8+dataOffset);
			if(!r.IsDBNull(9+dataOffset)) 
				dojoClass.occupancyCheckDate = r.GetDateTime(9+dataOffset);
			else
				dojoClass.occupancyCheckDate = DateTime.MinValue;
			dojoClass.signinStart = r.GetDateTime(10+dataOffset);
			dojoClass.signinEnd = r.GetDateTime(11+dataOffset);
			dojoClass.classStart = r.GetDateTime(12+dataOffset);
			dojoClass.classEnd = r.GetDateTime(13+dataOffset);
		}

		#endregion

		#region Default NitroCast Fill Methods

		#endregion

		#region Default NitroCast Delete Method

		internal static void _delete(int id)
		{
			StringBuilder query;
			Database database;
			DbCommand dbCommand;

			query = new StringBuilder("DELETE FROM kitTessen_Classes WHERE DojoClassID=");
			query.Append(id);
			query.Append(';');

			database = DatabaseFactory.CreateDatabase();
			dbCommand = database.GetSqlStringCommand(query.ToString());
			database.ExecuteNonQuery(dbCommand);

			cacheRemove(id);
		}

		#endregion

		#region Verify Table Methods

		public string VerifyTable(bool repair)
		{
			Database database;
			DbConnection dbConnection;
			DbCommand dbCommand;
			bool match;
			string[] restrictions1;
			StringBuilder msg;

			msg = new StringBuilder();
			restrictions1 = new string[] { null, null, tableName, null };

			database = DatabaseFactory.CreateDatabase();
			dbConnection = database.CreateConnection();
			dbConnection.Open();

			System.Data.DataTable schemaTable = dbConnection.GetSchema("Columns", restrictions1);

			// Loop through the join fields and columns in the
			// table schema to find which fields are missing.
			// Note that this search cannot use BinarySearch due
			// to the fact that JoinFields is unsorted.
			// A sorted JoinFields need not be used because this
			// method should be used sparingly.

			for(int i = 0; i <= JoinFields.GetUpperBound(0); i++)
			{
				match = false;
				foreach(System.Data.DataRow row in schemaTable.Rows)
				{
					if(JoinFields[i,0] == row[3].ToString())
					{
						match = true;
						break;
					}
				}
				if(!match)
				{
					if(repair)
					{
						dbCommand = database.GetSqlStringCommand("ALTER TABLE " + tableName + " ADD COLUMN " + JoinFields[i,0] + " " + JoinFields[i,1] + ";");
						database.ExecuteNonQuery(dbCommand);
						msg.AppendFormat("Added column '{0}'.", JoinFields[i,0]);
					}
					else
					{
						msg.AppendFormat("Missing column '{0}'.", JoinFields[i,0]);
					}
				}
			}

			GreyFoxContactManager locationManager = 
				new GreyFoxContactManager("kitTessen_Locations");
			msg.Append(locationManager.VerifyTable(repair));

			dbConnection.Close();
			return msg.ToString();
		}

		#endregion

		#region Default NitroCast Create Table Methods

		public void CreateReferences()
		{
			StringBuilder query;
			Database database;
			DbCommand dbCommand;

			query = new StringBuilder();
			database = DatabaseFactory.CreateDatabase();
			query.Append("ALTER TABLE kitTessen_Classes ADD ");
			query.Append(" CONSTRAINT FK_kitTessen_Classes_Instructor FOREIGN KEY (InstructorID) REFERENCES kitTessen_Members (DojoMemberID),");
			query.Append(" CONSTRAINT FK_kitTessen_Classes_ParentSeminar FOREIGN KEY (ParentSeminarID) REFERENCES kitTessen_Seminars (DojoSeminarID),");
			query.Append(" CONSTRAINT FK_kitTessen_Classes_ParentDefinition FOREIGN KEY (ParentDefinitionID) REFERENCES kitTessen_ClassDefinitions (DojoClassDefinitionID),");
			query.Append(" CONSTRAINT FK_kitTessen_Classes_Location FOREIGN KEY (LocationID) REFERENCES kitTessen_Locations (GreyFoxContactID),");
			query.Append(" CONSTRAINT FK_kitTessen_Classes_AccessControlGroup FOREIGN KEY (AccessControlGroupID) REFERENCES kitTessen_AccessControlGroups (DojoAccessControlGroupID);");
			dbCommand = database.GetSqlStringCommand(query.ToString());
			database.ExecuteNonQuery(dbCommand);
		}

		public void CreateTable()
		{
			StringBuilder query;
			Database database;
			DbCommand dbCommand;

			database = DatabaseFactory.CreateDatabase();

			if (database.ConnectionStringWithoutCredentials.StartsWith("provider=microsoft.jet.oledb.4.0"))
			{
				// Microsoft Jet SQL
				query = new StringBuilder("CREATE TABLE kitTessen_Classes ");
				query.Append(" (DojoClassID COUNTER(1,1) CONSTRAINT PK_kitTessen_Classes PRIMARY KEY, " +
					"Name TEXT(75)," +
					"InstructorID LONG," +
					"ParentSeminarID LONG," +
					"ParentDefinitionID LONG," +
					"LocationID LONG," +
					"AccessControlGroupID LONG," +
					"OccupancyMax LONG," +
					"OccupancyTarget LONG," +
					"OccupancyCurrent LONG," +
					"OccupancyCheckDate DATETIME," +
					"SigninStart DATETIME," +
					"SigninEnd DATETIME," +
					"ClassStart DATETIME," +
					"ClassEnd DATETIME);");
			}
			else
			{
				// Microsoft SQL Server
				query = new StringBuilder("CREATE TABLE kitTessen_Classes ");
				query.Append(" (DojoClassID INT IDENTITY(1,1) CONSTRAINT PK_kitTessen_Classes PRIMARY KEY, " +
					"Name NVARCHAR(75)," +
					"InstructorID INT," +
					"ParentSeminarID INT," +
					"ParentDefinitionID INT," +
					"LocationID INT," +
					"AccessControlGroupID INT," +
					"OccupancyMax INT," +
					"OccupancyTarget INT," +
					"OccupancyCurrent INT," +
					"OccupancyCheckDate DATETIME," +
					"SigninStart DATETIME," +
					"SigninEnd DATETIME," +
					"ClassStart DATETIME," +
					"ClassEnd DATETIME);");
			}

			dbCommand = database.GetSqlStringCommand(query.ToString());
			database.ExecuteNonQuery(dbCommand);

			//
			// Create object level table for Location.
			//
			GreyFoxContactManager locationManager = new GreyFoxContactManager("kitTessen_Locations");
			locationManager.CreateTable();

		}

		#endregion

		#region Cache Methods

		private static void cacheStore(DojoClass dojoClass)
		{
			CacheManager cache = CacheFactory.GetCacheManager();
			cache.Add("kitTessen_Classes_" + dojoClass.iD.ToString(), dojoClass);
		}

		private static DojoClass cacheFind(int id)
		{
			object cachedObject;
			CacheManager cache = CacheFactory.GetCacheManager();
			cachedObject = cache.GetData("kitTessen_Classes_" + id.ToString());
			if(cachedObject == null)
				return null;
			return (DojoClass)cachedObject;
		}

		private static void cacheRemove(int id)
		{
			CacheManager cache = CacheFactory.GetCacheManager();
			cache.Remove("kitTessen_Classes_" + id.ToString());
		}

		#endregion

		//--- Begin Custom Code ---

        public int ClassCountByInstructor(int instructorID)
        {
            Database database = DatabaseFactory.CreateDatabase();
            DbCommand dbCommand = database.GetSqlStringCommand("SELECT COUNT(*) " +
                "FROM kitTessen_Classes WHERE InstructorID=@InstructorID;");
            database.AddInParameter(dbCommand, "@InstructorID", DbType.Int32, instructorID);
            int count = (int)database.ExecuteScalar(dbCommand);
            return count;
        }

		//--- End Custom Code ---
	}
}

